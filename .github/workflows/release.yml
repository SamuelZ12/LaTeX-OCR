name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.3.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    runs-on: macos-14

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Extract version from tag
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Use manual version input
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Build for Release
        run: |
          xcodebuild \
            -project ScreenScribe.xcodeproj \
            -scheme ScreenScribe \
            -configuration Release \
            -derivedDataPath build \
            -destination 'generic/platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            build

      - name: Verify build output
        run: |
          APP_PATH="build/Build/Products/Release/ScreenScribe.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: App not found at $APP_PATH"
            ls -la build/Build/Products/Release/ || echo "Release directory not found"
            exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "Build successful: $APP_PATH"

      - name: Create DMG
        run: |
          DMG_NAME="ScreenScribe-${{ env.VERSION }}.dmg"

          mkdir -p dmg_contents
          cp -R "${{ env.APP_PATH }}" dmg_contents/
          ln -s /Applications dmg_contents/Applications

          hdiutil create -volname "ScreenScribe ${{ env.VERSION }}" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      - name: Generate checksum
        run: |
          shasum -a 256 "${{ env.DMG_NAME }}" > "${{ env.DMG_NAME }}.sha256"

      - name: Create tag for manual dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ env.VERSION }}" -m "Release v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.DMG_NAME }}
            ${{ env.DMG_NAME }}.sha256
          tag_name: v${{ env.VERSION }}
          name: ScreenScribe v${{ env.VERSION }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
          body: |
            ## Installation

            1. Download `${{ env.DMG_NAME }}`
            2. Open the DMG file
            3. Drag ScreenScribe to your Applications folder
            4. See [README](https://github.com/${{ github.repository }}#installation--usage) for first-run instructions

            **Note:** This app is not notarized. macOS Gatekeeper will show a warning on first launch. Right-click the app and select "Open" to bypass the warning.

            ---

            **SHA-256 Checksum:** See `${{ env.DMG_NAME }}.sha256`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
